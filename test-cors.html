<!DOCTYPE html>
<html>
<head>
    <title>Chart API Test</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        button { margin: 10px; padding: 10px; }
        #result { margin: 20px 0; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .error { color: red; }
        .success { color: green; }
        .loading { color: blue; }
    </style>
</head>
<body>
    <h2>Chart API Test</h2>
    <div>
        <button onclick="testProxyAPI()">Test Chart Proxy</button>
    </div>
    <div id="result"></div>
    <img id="chartImage" style="max-width: 100%; margin-top: 20px;"/>

    <script>
        const resultDiv = document.getElementById('result');
        const chartImage = document.getElementById('chartImage');

        function showResult(title, data, type = 'success') {
            resultDiv.innerHTML = `<div class="${type}">
                <strong>${title}</strong><br>
                <pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>
            </div>`;
        }

        async function testProxyAPI() {
            showResult('Testing chart API...', '', 'loading');
            chartImage.src = '';
            
            try {
                // Build the query parameters
                const params = new URLSearchParams({
                    symbol: 'BINANCE:BTCUSDT',
                    interval: '1h',
                    theme: 'dark',
                    studies: 'RSI@tv-basicstudies,MACD@tv-basicstudies',
                    timezone: 'Etc/UTC',
                    height: '600',
                    width: '1000',
                    range: '6M',
                    details: 'true'
                });

                // Use our Express server endpoint
                const url = `http://localhost:3000/api/chart?${params}`;
                console.log('Requesting:', url);

                const response = await fetch(url);
                const contentType = response.headers.get('Content-Type');
                
                console.log('Response details:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = await response.text();
                    }
                    throw new Error(JSON.stringify(errorData, null, 2));
                }

                if (contentType?.includes('image')) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    chartImage.src = imageUrl;
                    
                    showResult('Success!', {
                        status: response.status,
                        contentType,
                        size: blob.size,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                } else {
                    const data = await response.json();
                    throw new Error(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                let errorMessage;
                try {
                    errorMessage = JSON.parse(error.message);
                } catch {
                    errorMessage = error.message;
                }
                showResult('Error', errorMessage, 'error');
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
